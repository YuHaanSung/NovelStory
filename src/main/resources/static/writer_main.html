<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‘ê°€ ìŠ¤íŠœë””ì˜¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
    </style>
</head>
<body>
<script src="/js/header.js"></script>
<script src="https://cdn.portone.io/v2/browser-sdk.js"></script>

<div class="max-w-5xl mx-auto px-4 py-8">

    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 flex flex-col md:flex-row items-center gap-6 mb-6">
        <div class="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-md relative">
            <span id="profile-initial">?</span>
            <span id="profile-crown" class="hidden absolute -top-2 -right-2 text-2xl">ğŸ‘‘</span>
        </div>

        <div class="text-center md:text-left flex-1">
            <div class="flex items-center justify-center md:justify-start gap-2 mb-2">
                <h1 class="text-2xl font-bold text-gray-900" id="display-name">ì‘ê°€ë‹˜</h1>
                <span id="vip-badge" class="hidden bg-yellow-100 text-yellow-700 text-xs font-bold px-2 py-1 rounded-full border border-yellow-200">
                    VIP ìœ ì €
                </span>
            </div>
            <p class="text-gray-500 text-lg" id="display-intro">ìê¸°ì†Œê°œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <div class="flex gap-3">
            <button onclick="location.href='novel_create.html'" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center gap-2">
                <span>+ ìƒˆ ì‘í’ˆ ë§Œë“¤ê¸°</span>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 mb-10">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 flex items-center justify-between transition hover:shadow-md">
            <div>
                <p class="text-sm font-medium text-gray-500 mb-1">ë‚´ ì´ ìˆ˜ìµê¸ˆ</p>
                <div class="flex items-end gap-1">
                    <h2 class="text-3xl font-bold text-gray-900" id="revenue-display">0</h2>
                    <span class="text-lg font-medium text-gray-400 mb-1">ì›</span>
                </div>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
        </div>
    </div>

    <div id="payment-box" class="mb-10 p-6 bg-yellow-50 border border-yellow-200 rounded-xl hidden">
        <h3 class="text-lg font-bold text-gray-800 mb-2">ğŸ’ VIP ìœ ì €ë¡œ ì—…ê·¸ë ˆì´ë“œ</h3>
        <p class="text-sm text-gray-600 mb-4">ì›” 5,000ì›ìœ¼ë¡œ ë…¸ë²¨í—ˆë¸Œì˜ ëª¨ë“  ì†Œì„¤ì„ ì¦ê²¨ë³´ì„¸ìš”!</p>
        <button onclick="requestPay()" class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg shadow-md transition">
            ì¹´ì¹´ì˜¤í˜ì´ë¡œ 5,000ì› ê²°ì œí•˜ê¸°
        </button>
    </div>

    <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            ğŸ“š ë‚´ ì‘í’ˆ ëª©ë¡
        </h2>
    </div>

    <div id="novel-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    </div>

</div>

<script>
    window.onload = function() {
        // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤ ì´ë¦„ í™•ì¸ (ì½”ë“œ ì›ë³¸ì— ë”°ë¼ loginAuthorId ì‚¬ìš©)
        const authorId = localStorage.getItem('loginAuthorId');

        if (!authorId) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
            window.location.href = 'login.html';
            return;
        }

        // 1. ì‘ê°€ ê¸°ë³¸ ì •ë³´ ë° ì†Œì„¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        fetch('/api/authors/' + authorId)
            .then(res => { if(!res.ok) throw new Error(); return res.json(); })
            .then(data => {
                // 1-1. ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
                document.getElementById('display-name').innerText = data.name;
                document.getElementById('display-intro').innerText = data.introduction || "ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.";
                document.getElementById('profile-initial').innerText = data.name.charAt(0);

                // 1-2. VIP ì—¬ë¶€ì— ë”°ë¥¸ í™”ë©´ ì²˜ë¦¬
                const vipBadge = document.getElementById('vip-badge');
                const profileCrown = document.getElementById('profile-crown');
                const paymentBox = document.getElementById('payment-box');

                if (data.role === 'VIP') {
                    // VIPë¼ë©´? -> ë°°ì§€ ë³´ì—¬ì£¼ê³ , ê²°ì œì°½ ìˆ¨ê¹€
                    vipBadge.classList.remove('hidden');
                    profileCrown.classList.remove('hidden');
                    paymentBox.classList.add('hidden');
                } else {
                    // ì¼ë°˜ ìœ ì €ë¼ë©´? -> ë°°ì§€ ìˆ¨ê¸°ê³ , ê²°ì œì°½ ë³´ì—¬ì¤Œ
                    vipBadge.classList.add('hidden');
                    profileCrown.classList.add('hidden');
                    paymentBox.classList.remove('hidden');
                }

                // 1-3. ì†Œì„¤ ëª©ë¡ ê·¸ë¦¬ê¸°
                const container = document.getElementById('novel-list-container');
                container.innerHTML = '';

                if (data.novels && data.novels.length > 0) {
                    data.novels.forEach(novel => {
                        let tagHtml = '';
                        if(novel.tag){
                            const tags = Array.isArray(novel.tag) ? novel.tag : [novel.tag];
                            tags.forEach(t => tagHtml += `<span class="text-xs font-medium text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md mr-1">#${t}</span>`);
                        }

                        const html = `
                                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-lg transition-all duration-300 flex flex-col h-full group">
                                    <div class="p-6 flex flex-col h-full">
                                        <div class="mb-2">${tagHtml}</div>
                                        <h3 class="text-lg font-bold text-gray-900 mb-2 group-hover:text-indigo-600 cursor-pointer"
                                            onclick="location.href='novel_home.html?title=' + encodeURIComponent('${novel.title}')">${novel.title}</h3>
                                        <p class="text-gray-500 text-sm line-clamp-2 mb-4 flex-1">${novel.summary}</p>

                                        <div class="flex gap-2 pt-4 border-t border-gray-100 mt-auto">
                                            <button onclick="goWrite('${novel.title}')" class="flex-1 bg-gray-50 hover:bg-gray-100 text-gray-700 py-2 rounded-lg text-sm font-medium transition">
                                                âœï¸ íšŒì°¨ ì“°ê¸°
                                            </button>
                                            <button onclick="goManage('${novel.title}')" class="px-3 bg-gray-50 hover:bg-gray-100 text-gray-500 rounded-lg transition">
                                                âš™ï¸
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        container.innerHTML += html;
                    });
                } else {
                    container.innerHTML = `<div class="col-span-full py-12 text-center text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">ì•„ì§ ë“±ë¡ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</div>`;
                }
            })
            .catch(() => { alert("ì •ë³´ ë¡œë”© ì‹¤íŒ¨"); });

        // 2. [ì¶”ê°€ëœ ê¸°ëŠ¥] ìˆ˜ìµê¸ˆ ê°€ì ¸ì˜¤ê¸°
        // ì‘ì„±í•´ì£¼ì‹  ë°±ì—”ë“œ: @GetMapping("/api/authors/{authorId}/revenue")
        fetch('/api/authors/' + authorId + '/revenue')
            .then(res => {
                if(!res.ok) throw new Error("ìˆ˜ìµê¸ˆ ì¡°íšŒ ì‹¤íŒ¨");
                return res.json(); // Long íƒ€ì…(ìˆ«ì) ë°˜í™˜
            })
            .then(revenue => {
                // ì²œ ë‹¨ìœ„ ì½¤ë§ˆ ì°ì–´ì„œ í‘œì‹œ
                document.getElementById('revenue-display').innerText = revenue.toLocaleString();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('revenue-display').innerText = "0";
            });
    };

    function goManage(title) { location.href = 'novel_manage.html?title=' + encodeURIComponent(title); }
    function goWrite(title) { location.href = 'novel_part_create.html?title=' + encodeURIComponent(title); }

    // ê²°ì œ í•¨ìˆ˜
    async function requestPay() {
        const authorId = localStorage.getItem('loginAuthorId');
        if (!authorId) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }
        const paymentId = `payment-${crypto.randomUUID()}`;

        const response = await PortOne.requestPayment({
            storeId: "store-3ff44a84-f06c-4b2f-9062-6d1e30c18035",
            channelKey: "channel-key-929ea489-d898-4bea-a82b-ba03f4695553",
            paymentId: paymentId,
            orderName: "VIP ì‘ê°€ ë©¤ë²„ì‹­",
            totalAmount: 5000,
            currency: "CURRENCY_KRW",
            payMethod: "EASY_PAY",
            customer: { fullName: authorId }
        });

        if (response.code != null) { return alert("ê²°ì œ ì‹¤íŒ¨/ì·¨ì†Œ: " + response.message); }

        try {
            const res = await fetch(`/api/authors/${authorId}/upgradeToVIP`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: authorId, paymentInfo: response.paymentId })
            });
            const msg = await res.text();
            alert(msg);
            location.reload();
        } catch (e) { alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    }
</script>
</body>
</html>